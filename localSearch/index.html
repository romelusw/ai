<!DOCTYPE html>
<html>
    <head>
        <link href="css/styles.css" media="all" rel="stylesheet" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script type="text/javascript" src="js/ternarySearchTree.js"></script>
        <script type="text/javascript" src="js/wordGramMap.js"></script>
    </head>

    <body>
        <div id="wrapper">
            <h2>Contextual Search (sort of)</h2>
            <div id="corpusUpload">
                <textarea id="userCorpus" placeholder="Enter corpus data here ..."></textarea>
                <button style="float:left">Load Corpus</button>
                <p id="stats"></p>
                <div class="clear"></div>
            </div>
            <form id="queryForm">
                <input type="text" id="query" autocomplete="off" placeholder="Search">
                <ul id="query_autocomplete_results">
                    <div class="clear"></div>
                </ul>
            </form>
        </div>
        
        <script type="text/javascript">
            var tst;
            var bigram;

            // Handlers
            $("#corpusUpload button").click(function() {
                // Reclaim memory
                tst = new TST();
                bigram = new GramHashMap();
                var start = new Date();

                wordGrams($("#userCorpus").val(), 2).forEach(function(i, k) {
                    tst.add(i[0]);
                    bigram.add(i[0], i[1]);
                });
                $("#stats").html("Ngram + TST generated in <span class=\"emp\">" + (new Date() - start) + "ms</span>.");
            });

            $("#query").keyup(function(evt) {
                var query = $(this).val().split(" ");
                if(tst && bigram && tst.size() > 0 && bigram.size() > 0) {
                    var last = query[query.length - 1];
                    var prev = query[query.length - 2];
                    if(query.length > 1 && evt.keyCode == 32) {
                        populateList(prev, bigram.get(prev));
                    } else if(last.match(/[a-z0-9-_]{2,}/)) { // Ensure valid pattern
                        populateList(last, tst.get(last));
                    } else {
                        populateList(undefined, undefined);
                    }
                }
            });

            function populateList(prefix, data) {
                $("#query_autocomplete_results").empty();

                if(prefix !== undefined && data !== undefined) {
                    data.forEach(function(i, k) {
                        var lastCharacterLoc = i.word.indexOf(prefix[prefix.length - 1]);
                        $("#query_autocomplete_results").append("<li><span class=\"emp\">" + i.word.slice(0, lastCharacterLoc + 1) + "</span>" + i.word.slice(lastCharacterLoc + 1, i.word.length) + "</li>");
                        });
                }
            }

            function wordGrams(sentence, numWords) {
                var result = new Array();
                var words = sentence.toLowerCase().replace(/[^a-zA-Z ]/g, " ").split(" ");
                for(var i = 0; i < words.length - numWords; i++) {
                    for(var j = 0; j < numWords; j++) {
                        if(result[i] === undefined) {
                            result[i] = new Array();
                        }
                        result[i].push(words[i + j]);
                    }
                }
                return result;
            }
        </script>
    </body>
</html>